# Hub-Spoke Schema Protocol — Design Proposal

**Context:** Issue [#76](https://github.com/mellanon/pai-collab/issues/76) on pai-collab identifies the gap: no formal schema for blackboard repos (hub or spoke). This proposal addresses the spoke side — what a satellite project needs to expose so the hub can pull status.

**Dogfooding:** pai-collab-bundle itself is the first spoke. We'll implement the spoke schema here and use the collab CLI to read it.

---

## The Problem

The hub (pai-collab) has PROJECT.yaml pointing to source repos:

```yaml
source:
  repo: mellanon/pai-collab-bundle
  branch: main
```

But there's no contract for what the hub can expect to find in that repo. Without a spoke-side schema:
- The CLI can't reliably pull status from satellite projects
- Each spoke is a black box — the hub only knows what's manually journaled
- Status updates require a human to context-switch to the hub and update PROJECT.yaml

## Design Principles

1. **Spoke schema is lightweight** — a source code repo shouldn't need full governance
2. **Hub owns coordination** — PROJECT.yaml, JOURNAL.md, issues, reviews stay on the hub
3. **Spoke owns execution** — code, tests, feature status, local development state
4. **The CLI bridges** — reads spoke manifest, translates to hub-readable status
5. **Convention over invention** — reuse existing PAI tooling (SpecFlow, bun test) where possible

## Proposed Spoke Schema

A spoke project includes a `.collab/` directory at the repo root:

```
spoke-repo/
├── .collab/
│   ├── manifest.yaml    ← Required: spoke identity and status contract
│   └── status.yaml      ← Auto-generated: current execution state
├── .specflow/           ← Optional: SpecFlow feature tracking
├── packages/            ← Source code
└── ...
```

### manifest.yaml (human-maintained)

The stable contract that tells the hub what this spoke is and how to query it.

```yaml
# .collab/manifest.yaml
name: pai-collab-bundle
hub: mellanon/pai-collab           # Which hub this spoke reports to
project: collab-bundle             # Project directory name on the hub
maintainer: mellanon

# How to query spoke state
status:
  test: bun test                   # Command to run tests
  specflow: true                   # Has .specflow/ feature tracking
  healthCheck: bun run typecheck   # Optional: additional health check

# What the hub can read
exports:
  features: .specflow/features.db  # SpecFlow feature database
  readme: README.md                # Project readme
  changelog: CHANGELOG.md          # Optional: changelog
```

### status.yaml (auto-generated by CLI)

Snapshot of current execution state, regenerated by `collab spoke sync`.

```yaml
# .collab/status.yaml — auto-generated, do not edit
generatedAt: "2026-02-01T19:30:00Z"
generatedBy: collab-cli v1.0.0

phase: specify          # Current development phase
specflow:
  total: 17
  completed: 0
  inProgress: 0
  pending: 17
  progress: 0%
  nextFeature: F-1

tests:
  command: bun test
  lastRun: null         # Will be set after first test run
  passing: null
  total: null

git:
  branch: main
  lastCommit: "2026-02-01"
  dirty: false
  behindRemote: 0
```

## How the CLI Uses This

### From the spoke (developer working on the project)

```bash
# Generate/update status.yaml from current state
collab spoke sync

# Push status to hub (creates PR or updates journal)
collab spoke report
```

### From the hub (querying satellite projects)

```bash
# Pull status from all spoke repos that have .collab/manifest.yaml
collab project status signal --include-spoke

# Aggregate view across all spokes
collab status --include-spokes
```

### The flow

```
Developer works on spoke
         │
         ▼
collab spoke sync          ← reads .specflow/, runs tests, generates status.yaml
         │
         ▼
collab spoke report        ← pushes summary to hub (journal entry or issue comment)
         │
         ▼
Hub CLI reads status       ← collab project status --include-spoke
```

## Relationship to Issue #76

Issue #76 proposes five schema deliverables. This spoke protocol addresses:

| #76 Deliverable | This Proposal |
|-----------------|---------------|
| `schemas/blackboard.yaml` | manifest.yaml is the spoke-side portion |
| Directory structure convention | `.collab/` directory at spoke root |
| Validation tooling | `collab validate --spoke` checks manifest.yaml |
| Hub vs spoke differences | Hub: full governance. Spoke: manifest + auto-status |

The hub-side schema (TASKLIST.md, TELOS, etc.) from #76 is separate work. This proposal focuses on the spoke contract that enables hub→spoke status pull.

## Future Vision: Federated Hubs

The current design assumes pai-collab as the single hub. But the model generalizes to a **federated network** of blackboards:

```
Hub A (pai-collab)          Hub B (company-internal)       Hub C (research group)
  ├── spoke-1                 ├── spoke-5                    ├── spoke-8
  ├── spoke-2                 ├── spoke-6                    └── spoke-9
  └── spoke-3 ◄──────────────┤── spoke-3 (same spoke!)
                              └── spoke-7
```

**Key observations:**
- Different hubs have different trust models, governance, and scale
- A spoke could report to multiple hubs (e.g., an open-source tool used in both a community and a company)
- Smaller groups may run lightweight hubs with fewer SOPs
- Git + GitHub infrastructure already provides the coordination primitives (PRs, issues, branches)
- Contributor identity travels via GitHub accounts across hubs

**Design for federation, build for single hub:** The v1.0 manifest.yaml uses `hub: mellanon/pai-collab` (singular). A future version could support `hubs: [...]` (array). The CLI reads one hub for now. The schema is designed so this transition is additive, not breaking.

**Parked:** Blockchain-based audit trails and decentralized identity. Git already provides tamper-evident history. GitHub provides identity. These are sufficient for the foreseeable scale.

## Scope for v1.0

### In scope
- `.collab/manifest.yaml` schema definition
- `.collab/status.yaml` auto-generation
- `collab spoke sync` command (local status generation)
- `collab validate --spoke` command

### Out of scope (future)
- `collab spoke report` (push to hub) — requires hub-side acceptance
- Automatic status pull from hub CLI
- Hub-side schema (TASKLIST.md, TELOS, etc.)
- Multi-hub support (spoke reporting to multiple hubs)
- Federated identity and cross-hub discovery

## Impact on Feature Definitions

The current 17 features need additions:

| New Feature | Description |
|-------------|-------------|
| F-18: Spoke manifest schema | Define and validate .collab/manifest.yaml |
| F-19: Spoke status generation | `collab spoke sync` — read SpecFlow, git, tests, generate status.yaml |
| F-20: Spoke validation | `collab validate --spoke` — check manifest.yaml against schema |

Existing features F-7 (project status) and F-11 (collab status) should be extended to optionally read spoke status.yaml when `--include-spoke` is passed and the spoke repo is locally cloned.
